# SPDX-License-Identifier: (GPL-2.0+ OR MIT)

MODULE_NAME = amlogic_cve

obj-m += $(MODULE_NAME).o

$(MODULE_NAME)-y = src/cve.o
$(MODULE_NAME)-y += src/cve_op.o

M_PATH := $(shell dirname $(lastword $(MAKEFILE_LIST)))

LOCAL_INCLUDES := -I$(M_PATH)/inc

ifeq ($(PLATFORM_VERSION),)
    ccflags-y += -DCONFIG_T7
else
    ccflags-y += -DCONFIG_$(PLATFORM_VERSION)
endif

KBUILD_CFLAGS_MODULE += $(GKI_EXT_MODULE_PREDEFINE)

ccflags-y += $(LOCAL_INCLUDES)

EXTRA_CFLAGS += $(LOCAL_INCLUDES)

ifeq ($(O),)
out_dir := .
else
out_dir := $(O)
endif

#include $(OUT_DIR)/$(OUT_DIR)/$(O)/${out_dir}/include/config/auto.conf
-include $(out_dir)/include/config/auto.conf


all:
	@$(MAKE) -C $(KERNEL_SRC)  M=$(M) modules

modules_install:
	-include $(OUT_DIR)/include/config/auto.conf
	$(MAKE) M=$(M) -C $(KERNEL_SRC) modules_install
	mkdir -p ${out_dir}/../vendor_lib/modules
	if [ -z "$(CONFIG_AMLOGIC_KERNEL_VERSION)" ]; then \
		cp $(out_dir)/$(M)/*.ko ${out_dir}/../vendor_lib/modules/ ; \
	else \
		find $(INSTALL_MOD_PATH)/lib/modules/*/$(INSTALL_MOD_DIR) -name "*.ko" -exec cp {} ${out_dir}/../vendor_lib/modules \; ; \
	fi;

clean:
	@$(MAKE) -C $(KERNEL_SRC) M=$(M) clean
